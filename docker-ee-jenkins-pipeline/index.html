<!DOCTYPE html><html><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link rel="preload" href="/component---src-layouts-index-js-109cd0e4cf158481e9c4.js" as="script"/><link rel="preload" href="/component---src-templates-blog-post-js-b429ab3ba98728c6121d.js" as="script"/><link rel="preload" href="/path---docker-ee-jenkins-pipeline-a3904bb2eafec0f4fad5.js" as="script"/><link rel="preload" href="/app-8989174422f5bfbcc1e9.js" as="script"/><link rel="preload" href="/commons-581f82a2f76d1a2b9848.js" as="script"/><title data-react-helmet="true">Docker Enterprise Edition Continuous Integration and Deployment - Viseo Asia</title><meta data-react-helmet="true" name="description" content="Viseo Asia Innovation Labs Blob"/><meta data-react-helmet="true" name="keywords" content="viseo"/><script data-react-helmet="true" src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script><style id="gatsby-inlined-css">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:112.5%/1.45em georgia,serif;box-sizing:border-box;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{color:rgba(0,0,0,.8);font-family:georgia,serif;font-weight:400;word-wrap:break-word;-webkit-font-kerning:normal;font-kerning:normal;-ms-font-feature-settings:"kern","liga","clig","calt";-webkit-font-feature-settings:"kern","liga","clig","calt";font-feature-settings:"kern","liga","clig","calt","kern"}img{max-width:100%;margin:0 0 1.45rem;padding:0}h1{font-size:2.25rem}h1,h2{margin:0 0 1.45rem;padding:0;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{margin:0 0 1.45rem;padding:0;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{margin:0 0 1.45rem;padding:0;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h6{font-size:.78405rem}hgroup{margin:0 0 1.45rem;padding:0}ol,ul{margin:0 0 1.45rem 1.45rem;padding:0;list-style-position:outside;list-style-image:none}dd,dl,figure,p{margin:0 0 1.45rem;padding:0}pre{padding:0;font-size:.85rem;line-height:1.42;background:rgba(0,0,0,.04);border-radius:3px;overflow:auto;word-wrap:normal;padding:1.45rem}pre,table{margin:0 0 1.45rem}table{padding:0;font-size:1rem;line-height:1.45rem;border-collapse:collapse;width:100%}fieldset{margin:0 0 1.45rem;padding:0}blockquote{margin:0 1.45rem 1.45rem;padding:0}form,iframe,noscript{margin:0 0 1.45rem;padding:0}hr{margin:0 0 calc(1.45rem - 1px);padding:0;background:rgba(0,0,0,.2);border:none;height:1px}address{margin:0 0 1.45rem;padding:0}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-left:1.45rem;margin-bottom:.725rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:SFMono-Regular,Consolas,Roboto Mono,Droid Sans Mono,Liberation Mono,Menlo,Courier,monospace;padding:0;padding-top:.2em;padding-bottom:.2em}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{letter-spacing:-.2em;content:" "}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}</style></head><body><div id="___gatsby"><div data-reactroot="" data-reactid="1" data-react-checksum="-746762912"><!-- react-empty: 2 --><div style="background:#1B3866;margin-bottom:1.45rem;" data-reactid="3"><div style="margin:0 auto;max-width:960px;padding:1.45rem 1.0875rem;" data-reactid="4"><h1 style="margin:0;" data-reactid="5"><a style="color:white;text-decoration:none;" href="/" data-reactid="6"><!-- react-text: 7 -->VISEO Asia <!-- /react-text --><span style="font-family:verdana; serif;font-size:0.6em;font-style:italic;" data-reactid="8">Innovation Labs</span></a></h1></div></div><div style="margin:0 auto;max-width:960px;padding:0px 1.0875rem 1.45rem;padding-top:0;" data-reactid="9"><div data-reactid="10"><!-- react-empty: 11 --><div data-reactid="12"><h1 data-reactid="13">Docker Enterprise Edition Continuous Integration and Deployment</h1><h3 data-reactid="14">March 07, 2018</h3><div data-reactid="15"><h2>Overview</h2>
<p>This post will describe a technique to achieve Continuous Integration and Deployment in Docker Enterprise Edition using Jenkins Pipelines.</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/devops-process-1024x527-e86968505197fcadcb0d3aa8a6479bf1-9160a.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 51.46484375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAACiklEQVQoz11SXUhUQRSeO6NZ68yaSEkPBf6iq65mZVtbu/eura74k5VQtrv3rj+bRUWPkmYkREr50ksPWfYgBRFI0EPiQ20YpZlpapmVImJEiUIlRPRwOrMqmAOX4Z5z5jvf951DRKZKRLpTIXhiSS4xx+9LFFv3Z/NMdaOMbfB6SAyzKWQxGK6Rhw7r0WS2OoV8q0kjUGeSMWW6iihjBiE8TwsXiQxnJYJMcJcbuLsQ8H8Rv0ay5tAR3auMGpOsLwAs5Af6wjenvDPqZS6yvWKpCIHO4uMhYdWA73F18V3aHYzNcqv6kudq1xJIJA2zGDV6EPAHfauHaL+/k/X67iLgb4z/QXZlK2B2lA14P4pRbPGr2fCdWocoL5e52yjzFp07A8im+z/KC7XJ2OQp5r/inUJ4jtokCkpAJDvqCTRuon3+A+yZN5XAuTiR4IgXFuerqLYKkBKVceM5e1y5xbzZrkbbXZZoLT9x2YbLbLwO6JB+SgK2ipJSwEEUo8E7UEozdmtF4DpZzELeFjYYgIhuH5iOFF5ZZt6EdlzF+zoOMp18qT7MJk4CHfA3E56l6mZbkZR1f+0AyHzNcWUmKGXOm0oLfqLPE+tPF9tlClYP6rX/ARuuBfQxIFeGo6x+LB5E0BaR5twrUh0Wnq2eNx319NBe3wfyqzY/jmTlRTw89gQfLdBB/RL5XmPBRjYcyAU6HZRyPytTVXzJ/O2aQLB2s9UNwuEBXuABc24RiCTHzLq2QzkrTJRPgVK05C8bCQIbqAY6dUKy+ogedijvjYyl/ctUwwuL0mORqQ89vYlrcw8bNPDdriSZi7p4kEY1lLEw6GRgG65NA3rcSd/oNxDQh5Ijw7kxg/4DJCHefo1vLb0AAAAASUVORK5CYII='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="DevOps Process"
        title=""
        src="/static/devops-process-1024x527-e86968505197fcadcb0d3aa8a6479bf1-fb8a0.png"
        srcset="/static/devops-process-1024x527-e86968505197fcadcb0d3aa8a6479bf1-1a291.png 148w,
/static/devops-process-1024x527-e86968505197fcadcb0d3aa8a6479bf1-2bc4a.png 295w,
/static/devops-process-1024x527-e86968505197fcadcb0d3aa8a6479bf1-fb8a0.png 590w,
/static/devops-process-1024x527-e86968505197fcadcb0d3aa8a6479bf1-526de.png 885w,
/static/devops-process-1024x527-e86968505197fcadcb0d3aa8a6479bf1-9160a.png 1024w"
        sizes="(max-width: 590px) 100vw, 590px"
      />
    </span>
  </span>
  
  </a>
    </p>
<h2>TL;DR</h2>
<ol>
<li>Create a <strong>jenkins</strong> user in Docker Trusted Registry (DTR)</li>
<li>Create an application repository in DTR</li>
<li>Deploy a Docker Swarm Stack</li>
<li>Add a Jenkinsfile using Jenkins Pipelines to your application repository</li>
<li>Configure Jenkins DTR credentials</li>
<li>Commit code to application, build and deploy with Jenkins</li>
</ol>
<h2>Detail</h2>
<p>There's several ways to achieve CI and/or CD, often a key deciding factor is your application or business's governance policies.</p>
<p>For example can you use a CI/CD service or do you need to host your own.</p>
<p>For this post the CI/CD senario is that you cannot use an external service and the CaaS platform will be <a href="https://www.docker.com/enterprise-edition">Docker Enterprise Edition</a>.</p>
<p>There is essentially two parts: 1) Server configurations and 2) Application specific Jenkins pipeline scripting.</p>
<p>We have another reposistory that details the step by step setup for the server configurations which I'll link to <a href="https://github.com/viseo-asia/docker-enterprise-edition-demo">here</a></p>
<p>Once your server side is setup, we just need to drop in a Jenkinsfile in each application (or microservice) that we want to deploy.</p>
<p>Here's an exmaple that deploys a nodejs app.</p>
<p>At the root of your application repo add a <a href="https://github.com/viseo-asia/blockchain-civic-demo/blob/master/Jenkinsfile">Jenkinsfile</a> like the one below.</p>
<p>Then you just need to create a new job in Jenkins and point it to your Jenkinsfile in your git repo.</p>
<p>This pipeline will:</p>
<ol>
<li>Download the application code</li>
<li>Install dependencies</li>
<li>Execute unit tests and generate test coverage reports</li>
<li>Do code analysis and enforce quality rules like minimum percentage of test coverage</li>
<li>Build the docker image and tag it with the git commit id</li>
<li>Push the image to your local DTR</li>
<li>Deploy the image into your Docker swarm (Docker EE)</li>
</ol>
<p>If you have any questions or issues that aren't resolved by the documentation we've written please contact us.</p>
<pre class="prettyprint">pipeline {
    agent any
    
    environment {
        // NODE_ENV is dev for testing first, will prune dev dependencies before deploy.
        NODE_ENV = 'development'
    }
    
    stages {

        stage('Preparation') { 
            steps {
                git branch: 'master', url: 'https://github.com/viseo-asia/blockchain-civic-demo.git'
                script {
                    // sh 'printenv'
                    sh 'git rev-parse HEAD > .git/commit-id'
                }
            }
        }
        
        stage('Test') {
            steps {
                withDockerContainer(image: 'node:8.9.4-alpine') {
                    sh 'yarn install'
                    // sh 'printenv'
                    script {
                        commit_id = readFile('.git/commit-id')
                    }
                    echo "COMMIT ID: ${commit_id}"
                    sh 'npm run ci-test-coverage'
                    sh 'npm run ci-test-report'
                }
                script {
                    scannerHome = tool 'sonarqube';
                }
                withSonarQubeEnv('sonarqube') {
                    script {
                        sh "${scannerHome}/bin/sonar-scanner"
                    }
                }
            }
        }
        
        stage("Quality Gate") {
            steps {
                script {
                    qg = waitForQualityGate() // Reuse taskId previously collected by withSonarQubeEnv
                    if (qg.status != 'OK') {
                       error "Pipeline aborted due to quality gate failure: ${qg.status}"
                    }
                }
            }
        }

        stage('Build') {
            steps {
                echo "Git commit ID: ${commit_id}"
                script {
                    // the ${commit_id} tag seems to chop off anything trailing, so we build and tag seperately
                    sh "docker build -t viseo/civic-app ."
                    sh "docker tag viseo/civic-app local.dtr/viseo/civic-app:latest"
                    sh "docker tag viseo/civic-app local.dtr/viseo/civic-app:${commit_id}"

                }
            }
        }

        stage('Push') {
            steps {
                withDockerRegistry(url: 'https://local.dtr', credentialsId: 'dtr-credentials') {
                    // latest tag is not auto, so need to push twice - each layer is uploaded only once though (no double upload)
                    sh "docker push local.dtr/viseo/civic-app:latest"
                    sh "docker push local.dtr/viseo/civic-app:${commit_id}"
                }
            }
        }

        stage('Deploy') {
            steps {
                script {
                    sh "docker service update civic_web --detach=true --image local.dtr/viseo/civic-app:latest"
                }
            }
        }

    }
}</pre></div><p data-reactid="16"></p><p data-reactid="17"></p></div></div></div></div></div><script id="webpack-manifest">/*<![CDATA[*/window.webpackManifest={"231608221292675":"app-8989174422f5bfbcc1e9.js","205117723866763":"component---src-templates-all-tags-js-a109e949baa4beb6ccfa.js","50739212244294":"component---src-templates-tags-js-2438a5dc749174685298.js","107818501498521":"component---src-templates-blog-post-js-b429ab3ba98728c6121d.js","162898551421021":"component---src-pages-404-js-4503918ea3a16cfcdb75.js","35783957827783":"component---src-pages-index-js-6fb28e5c62f4fd6e5f07.js","60335399758886":"path----557518bd178906f8d58a.js","55702396619907":"path---tags-8d8715fd8a2738b9111e.js","216430911942909":"path---tags-continuous-delivery-d809eab7a63d0a8b5556.js","203397363053915":"path---tags-continuous-integration-501fc3729d61fd74f093.js","197808841186072":"path---tags-docker-ca86c5b7138c043a8a9e.js","218913375992731":"path---tags-jenkins-f91f13989d3ddb56d0dd.js","275133165580617":"path---docker-ee-jenkins-pipeline-a3904bb2eafec0f4fad5.js","254022195166212":"path---404-a0e39f21c11f6a62c5ab.js","142629428675168":"path---index-93949ddbb389b78022f7.js","178698757827068":"path---404-html-a0e39f21c11f6a62c5ab.js","114276838955818":"component---src-layouts-index-js-109cd0e4cf158481e9c4.js"}/*]]>*/</script><script>
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-46997328-3', 'auto');
      }
      </script><script>/*<![CDATA[*/!function(e,t,r){function n(){for(;d[0]&&"loaded"==d[0][f];)c=d.shift(),c[o]=!i.parentNode.insertBefore(c,i)}for(var s,a,c,d=[],i=e.scripts[0],o="onreadystatechange",f="readyState";s=r.shift();)a=e.createElement(t),"async"in i?(a.async=!1,e.head.appendChild(a)):i[f]?(d.push(a),a[o]=n):e.write("<"+t+' src="'+s+'" defer></'+t+">"),a.src=s}(document,"script",["/commons-581f82a2f76d1a2b9848.js","/app-8989174422f5bfbcc1e9.js","/path---docker-ee-jenkins-pipeline-a3904bb2eafec0f4fad5.js","/component---src-templates-blog-post-js-b429ab3ba98728c6121d.js","/component---src-layouts-index-js-109cd0e4cf158481e9c4.js"])/*]]>*/</script></body></html>